[
  {
    "parameters": {
      "jsCode": "// Ensure mutual exclusivity of Version vs Variant IDs\nconst data = $input.first().json;\n\nlet versionId = data.playbookVersionId;\nconst variantId = data.variantId;\n\n// If variant exists, we MUST clear versionId to satisfy constraint\nif (variantId) {\n  versionId = null; \n} \n// If variant doesn't exist, we keep versionId (and variantId is undefined/null)\n\nreturn {\n  ...data,\n  clean_version_id: versionId,\n  clean_variant_id: variantId || null\n};"
    },
    "type": "n8n-nodes-base.code",
    "typeVersion": 2,
    "position": [
      3504,
      624
    ],
    "id": "prepare-assessment-data-fix",
    "name": "Prepare Assessment Data"
  },
  {
    "parameters": {
      "tableId": "assessments",
      "operation": "insert",
      "fieldsUi": {
        "fieldValues": [
          {
            "fieldId": "organization_id",
            "fieldValue": "={{ $json.organizationId }}"
          },
          {
            "fieldId": "playbook_version_id",
            "fieldValue": "={{ $json.clean_version_id }}"
          },
          {
            "fieldId": "playbook_variant_id",
            "fieldValue": "={{ $json.clean_variant_id }}"
          },
          {
            "fieldId": "playbook_content_snapshot",
            "fieldValue": "={{ JSON.stringify($json.variantContent || $json.playbookContent) }}"
          },
          {
            "fieldId": "company_name",
            "fieldValue": "={{ $json.companyName }}"
          },
          {
            "fieldId": "current_stage",
            "fieldValue": "web_scan"
          },
          {
            "fieldId": "arr_range_snapshot",
            "fieldValue": "={{ $json.classification.estimated_arr_range }}"
          },
          {
            "fieldId": "assessment_type",
            "fieldValue": "={{ $json.assessmentType.toLowerCase().includes('partnership') ? 'partnership' : 'gtm_readiness' }}"
          }
        ]
      }
    },
    "type": "n8n-nodes-base.supabase",
    "typeVersion": 1,
    "position": [
      3728,
      624
    ],
    "id": "874ba1f9-f9ef-455e-9799-3a842863ffff",
    "name": "Create Assessment1",
    "credentials": {
      "supabaseApi": {
        "id": "FTSugGkqwnuu6irz",
        "name": "SupaStack"
      }
    }
  }
]